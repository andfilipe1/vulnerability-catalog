#!/bin/bash


cleaning_old() {
  #### Cleaning previous versions. Be careful.
  if [[ -d $project_name ]]; then
    rm -rf $project_name
  fi
}

check_system_reqs() {
  control="True"
  #### System requirements:
  #### python3 https://wiki.python.org/moin/Python2orPython3
  if [[ ! $(type -t python3) ]]; then
    echo
    echo "[Warning]    Missing python3."
    echo
    echo "Please, install python3 first."
    echo

    have_python="False"
  fi
  #### pip3 https://wiki.python.org/moin/Python2orPython3
  if [[ ! $(type -t pip3) ]]; then
    echo
    echo "[Warning]    Missing pip3."
    echo
    echo "Please, install pip3 first."
    echo

    have_pip="False"
  fi

  if [[ $have_python || $have_pip == "False" ]]; then
    echo
    echo "Fix system dependencies first. Exiting."
    exit 1
  fi

  #### django (2.0) https://docs.djangoproject.com
  if [[ ! $(type -t django-admin) ]]; then
    echo
    echo "[Warning]    Missing django2 (or greater)."
    echo
    echo "Fix it by running:"
    echo "    pip3 install django==2"
    echo
    control="False"
  else
    if [[ $(django-admin --version) != "2.0" ]]; then
      echo
      echo "[Warning]    django version is not 2 (or greater)."
      echo
      echo "Fix it by running:"
      echo "    pip3 install django==2"
      echo 
    fi
  fi
  #### django-chartjs (1.2)  https://github.com/novagile/django-chartjs
  if [[ ! $(pip3 show django-chartjs) ]]; then
    echo
    echo "[Warning]    Missing django-chartjs 1.2 (or greater)."
    echo
    echo "Fix it by running:"
    echo "    pip3 install django-chartjs==1.2"
    echo
    control="False"
  fi
  
  if [[ $control == "False" ]]; then
    echo "Missing django dependencies. Exiting."
    exit 1
  fi
}

start_project() {
  #### Starting project construction:
  django-admin startproject $project_name
  cd $project_name
}

start_app() { # No parameters need.
  #### Starting the $1 app into the project:
  python3 manage.py startapp $1
}

setting_project_urls() {
  #### Setting the project urls properly into the main project:
  url_tmpl_file=$base_dir/metadata/urls/admin/urls.py
  cp $url_tmpl_file $project_name/urls.py
}

add_app_to_project() { # pass app_name as a parameter.
  #### Add apps into the main project:
  _class_app_name_config_=$(echo $1 | sed -e 's/\b\(.\)/\u\1/g')Config # Class names start by uppercase.
  _str_="'$1.apps.$_class_app_name_config_'," 
  sed -i -e "/INSTALLED_APPS/a \    $_str_" $project_name/settings.py # inserting above 'urlpatters' line.
}

defining_datamodel(){ # pass app_name as a parameter.
  #### Defining the $1 DATAMODEL structure:
  models_dir=$1
  models_file=$models_dir/models.py
  models_tmpl_file=$base_dir/metadata/models/$1/models.py
  
  cp $models_tmpl_file $models_file
}

setting_app_urls(){ # pass app_name as a parameter.
  #### Setting URLs for the new app: $1/urls.py
  url_tmpl_file=$base_dir/metadata/urls/$1/urls.py
  
  cp $url_tmpl_file $1/urls.py
}

setting_app_views() { # pass app_name as a parameter.
  #### Adding the index view:
  ### $1/views.py
  views_tmpl_file=$base_dir/metadata/views/$1/views.py
  cp $views_tmpl_file $1/views.py
}

set_data_models(){ # pass app_name as a parameter.
  #### Enabling DATAMODEL into admin app:
  #### vulnerabilities/admin.py
  admin_tmpl_file=$base_dir/metadata/models/$1/admin.py
  cp $admin_tmpl_file  $1/admin.py
}

setting_catalog_index_table() { # pass app_name as a parameter.
                                # Works only for catalog app.
  #### Templates:
  tmpl_source_dir=$base_dir/metadata/templates/$1
  tmpl_dir=$1/templates/$1
  if [[ ! -d $tmpl_dir ]]; then
      mkdir -p $tmpl_dir
  fi
  
  tmpl_file=$tmpl_dir/index.html
  cp $tmpl_source_dir/tmpl_index_table.html $tmpl_file
  
  ### Creating catalog app's index table: 
  sed -e "s/__APP_NAME__/$1/g" -e '/__INSERT_CUSTOM_CONTENT__/ {' -e "r $tmpl_source_dir/index_table.html" -e 'd' -e '}' $tmpl_source_dir/tmpl_index_table.html > $tmpl_file
}

setting_catalog_home_table() { # pass app_name as a parameter.
                                # Works only for catalog app.
  #### Templates:
  tmpl_source_dir=$base_dir/metadata/templates/$1
  tmpl_dir=$1/templates/$1
  if [[ ! -d $tmpl_dir ]]; then
      mkdir -p $tmpl_dir
  fi
  
  tmpl_file=$tmpl_dir/home.html
  cp $tmpl_source_dir/tmpl_home_table.html $tmpl_file
  
  ### Creating catalog app's index table: 
  sed -e "s/__APP_NAME__/$1/g" -e '/__INSERT_CUSTOM_CONTENT__/ {' -e "r $tmpl_source_dir/home_table.html" -e 'd' -e '}' $tmpl_source_dir/tmpl_home_table.html > $tmpl_file
}

setting_catalog_detail_table() { # pass app_name as a parameter.
                                 # Works only for catalog app.
  #### Templates:
  tmpl_source_dir=$base_dir/metadata/templates/$1
  tmpl_dir=$1/templates/$1
  if [[ ! -d $tmpl_dir ]]; then
      mkdir -p $tmpl_dir
  fi
  
  tmpl_file=$tmpl_dir/detail.html
  cp $tmpl_source_dir/tmpl_detail_table.html $tmpl_file
  
  ### Creating $1 detail table
  sed -e "s/__APP_NAME__/$1/g" -e '/__INSERT_CUSTOM_CONTENT__/ {' -e "r $tmpl_source_dir/detail_table.html" -e 'd' -e '}' $tmpl_source_dir/tmpl_detail_table.html > $tmpl_file
}

setting_panorama_index_table() { # pass app_name as a parameter.
                                 # Works only for catalog app.
  #### Templates:
  view_name=panorama
  tmpl_source_dir=$base_dir/metadata/templates/$view_name
  tmpl_dir=$1/templates/$view_name
  if [[ ! -d $tmpl_dir ]]; then
      mkdir -p $tmpl_dir
  fi
  
  tmpl_file=$tmpl_dir/index.html
  cp $tmpl_source_dir/tmpl_index_table.html $tmpl_file
  
  ### Creating catalog app's index table: 
  sed -e "s/__APP_NAME__/$1/g" -e '/__INSERT_CUSTOM_CONTENT__/ {' -e "r $tmpl_source_dir/index_table.html" -e 'd' -e '}' $tmpl_source_dir/tmpl_index_table.html > $tmpl_file
}

setting_data_index_table() { # pass app_name as a parameter.
                             # Works only for catalog app.
  #### Templates:
  view_name=data
  tmpl_source_dir=$base_dir/metadata/templates/$view_name
  tmpl_dir=$1/templates/$view_name
  if [[ ! -d $tmpl_dir ]]; then
      mkdir -p $tmpl_dir
  fi
  
  tmpl_file=$tmpl_dir/index.html
  cp $tmpl_source_dir/tmpl_index_table.html $tmpl_file
  
  ### Creating catalog app's index table: 
  sed -e "s/__APP_NAME__/$1/g" -e '/__INSERT_CUSTOM_CONTENT__/ {' -e "r $tmpl_source_dir/index_table.html" -e 'd' -e '}' $tmpl_source_dir/tmpl_index_table.html > $tmpl_file
}


setting_panorama_detail_table() { # pass app_name as a parameter.
                                  # Works only for catalog app.
  #### Templates:
  tmpl_source_dir=$base_dir/metadata/templates/$1
  tmpl_dir=$1/templates/$1
  if [[ ! -d $tmpl_dir ]]; then
      mkdir -p $tmpl_dir
  fi
  
  tmpl_file=$tmpl_dir/detail.html
  cp $tmpl_source_dir/tmpl_detail_table.html $tmpl_file
  
  ### Creating $1 detail table
  sed -e "s/__APP_NAME__/$1/g" -e '/__INSERT_CUSTOM_CONTENT__/ {' -e "r $tmpl_source_dir/detail_table.html" -e 'd' -e '}' $tmpl_source_dir/tmpl_detail_table.html > $tmpl_file
}

setting_catalog_add_template() {
  #### Adding vulnerabilities page:
  #### Templates:
  tmpl_source_dir=$base_dir/metadata/templates/$1
  tmpl_dir=$1/templates/$1
  if [[ ! -d $tmpl_dir ]]; then
      mkdir -p $tmpl_dir
  fi
  
  tmpl_file=$tmpl_dir/add.html
  cp $tmpl_source_dir/tmpl_add_table.html $tmpl_file

  ### Creating catalog app's index table: 
  sed -e "s/__APP_NAME__/$1/g" -e '/__INSERT_CUSTOM_CONTENT__/ {' -e "r $tmpl_source_dir/add_table.html" -e 'd' -e '}' $tmpl_source_dir/tmpl_add_table.html > $tmpl_file

  ### Inserting cvss code properly:
  sed -i -e '/__INSERT_CVSS_CALCULATOR__/ {' -e "r $tmpl_source_dir/cvss-3.0-calculator.html" -e 'd' -e '}' $tmpl_file
}

setting_catalog_forms() {
    #### Ensures all catalog forms in forms.py were addressed properly:
    forms_source_dir=$base_dir/metadata/forms/$1
    forms_file=forms.py

    cp $forms_source_dir/$forms_file $1/$forms_file
}

setting_catalog_static_files() {
    #### Put all static content into app structure:
    static_source_dir=$base_dir/metadata/static/$1
    static_dst_dir=$1/static

    cp -fr $static_source_dir $static_dst_dir
}


setting_admin_template() {
  ####_FIX_ to use templates?
  #### Changing default admin session:
  tmpl_dir=./templates/admin
  if [[ ! -d $tmpl_dir ]]; then
      mkdir -p $tmpl_dir
  fi
  tmpl_file=$tmpl_dir/base_site.html
  touch $tmpl_file
  
  #### Setting $project_name/settings.py file:
  _str_="'DIRS': \[\]" 
  _str2_="'DIRS': \[os.path.join(BASE_DIR, 'templates')\]"
  sed -i -e "s/$_str_/$_str2_/" $project_name/settings.py
  
  #### base_site.html
  python_path=$(python3 -c "import django; print(django.__path__[0])")
  cp $python_path/contrib/admin/templates/admin/base.html $tmpl_dir
  cp $python_path/contrib/admin/templates/admin/base_site.html $tmpl_file
  
  #### Changing admin's banner name:
  sed -i -e '/site-name/d' $tmpl_file
  _str_="<h1 id=\"site-name\"><a href=\"{% url 'admin:index' %}\">Catalog administration</a></h1>"
  sed -i -e "/block branding/a \ $_str_" $tmpl_file
}

apply_data_models() { # pass app_name as a parameter.
  #### Applying the new data model:
  python3 manage.py makemigrations $1
  python3 manage.py sqlmigrate $1 0001
  python3 manage.py migrate
}

deployment_checklist(){
  #### Ensuring https://docs.djangoproject.com/en/1.10/howto/deployment/checklist/ requirements:
  #### Changing SECRET_KEY:
  echo "Generating secret key..."
  key=$(dd bs=4096 count=20 iflag=fullblock if=/dev/urandom 2>/dev/null | sha512sum | awk '{print $1}')
  #key=$(dd bs=4096 count=5 if=/dev/urandom 2> /dev/null | strings | tr -d "\'" | tr -d '\"' | tr -d '\`' | tr '\n' ' ')
  _str_="SECRET_KEY = '$key'"
  sed -i -e "s/^SECRET_KEY.*/$_str_/" $project_name/settings.py
  
  #### ALLOWED_HOSTS:
  _str_="ALLOWED_HOSTS = ['localhost', '127.0.0.1']"
  sed -i -e "s/^ALLOWED_HOSTS.*/$_str_/" $project_name/settings.py
}

create_test_enviroment() { # pass app_name as a parameter.
  #### Enable test capabilities to the project.
  app_name=$1
  if [[ ! -d $app_name/fixturename ]]; then
     mkdir -p $app_name/fixturename
  fi
  cp $base_dir/test/data/initialcatalogdata.json $app_name/fixturename/
  python3 manage.py loaddata $app_name/fixturename/initialcatalogdata.json
}

create_superuser() {
  #### Set admin and start server:
  python3 manage.py createsuperuser
}
  
run_new_project() {
  echo
  echo
  echo "Please access http://127.0.0.1:8000/admin to start app."
  
  python3 manage.py runserver
}

install_package(){
  #### Running the project creation process:
  #### The first app in this list will be the catalog:
  app_name=catalog
  
  #### Run it in this canonical order:
  #### Project configs
  start_project  # Must be the first to call
  start_app $app_name # pass app_name as a parameter.
  setting_project_urls # no parameters are need.
  add_app_to_project $app_name # pass app_name as a parameter.
  defining_datamodel $app_name # pass app_name as a parameter.
  
  #### Apps configs
  setting_app_urls $app_name # pass app_name as a parameter.
  setting_app_views $app_name # pass app_name as a parameter.
  
  #### Catalog view configs
  setting_catalog_index_table $app_name # pass app_name as a parameter.
  setting_catalog_detail_table $app_name # pass app_name as a parameter.
  
  #### Panorama view configs
  setting_panorama_index_table $app_name # pass app_name as a parameter.
  #setting_panorama_detail_table $app_name # pass app_name as a parameter.
  
  #### Data view configs
  setting_data_index_table $app_name # pass app_name as a parameter.
 
  #### Templates (this would be the new layout for templates):
  setting_catalog_add_template $app_name 
  setting_catalog_home_table $app_name


  #### Forms (this should put forms.py properly):
  setting_catalog_forms $app_name 
  
  #### static files (https://docs.djangoproject.com/en/2.0/howto/static-files/):
  setting_catalog_static_files $app_name 

  #### Admin template 
  setting_admin_template # no parameters are need.
  
  #### Final configs
  set_data_models $app_name # pass app_name as a parameter.
  apply_data_models $app_name # pass app_name as a parameter.
  deployment_checklist # no parameters are need.
  create_superuser # no parameters are need.
  create_test_enviroment $app_name # pass app_name as a parameter.
  run_new_project # no parameters are need.
}

#### Global variables:
project_name=base
base_dir=$(pwd)

cleaning_old
check_system_reqs
install_package
