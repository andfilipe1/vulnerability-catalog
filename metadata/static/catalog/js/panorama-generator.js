/*
 * Panorama constructor using d3.js, dc.js an crossfilter.js
 */
url = "/catalog/vulnerability/data/panorama/json"

// Coupling chart into the respective DOM elements:

// Getting data to visualize:
d3.json(url, function(error, data) {
  if (error) throw error; 

  // Grouping all data into the ndx index: 
  var ndx = crossfilter(data);
//  var all = ndx.groupAll();

  // Perimeter chart:
  var perimeterChart = dc.rowChart("#perimeterChart");
  var perimeterDim = ndx.dimension(function (d) { return d["perimeter"]; })
  var perimeterGroup = perimeterDim.group();

  perimeterChart
    .x(d3.scale.linear(perimeterDim))
    .dimension(perimeterDim)
    .group(perimeterGroup)
    .elasticX(true)
    .label(function(d){ // https://stackoverflow.com/questions/30465870
            return d.key + ": " + (d.value / ndx.groupAll().reduceCount().value() * 100).toFixed(0) + "%";
        });

  // Status chart:
  var statusChart = dc.pieChart("#statusChart");
  var statusDim = ndx.dimension(function (d) { return d["status"]; })
  var statusGroup = statusDim.group();

  statusChart
    .dimension(statusDim)
    .group(statusGroup)
    .legend(dc.legend())
    .colors(d3.scale.category20())
    // http://colorbrewer2.org/#type=sequential&scheme=Reds&n=3
//    .colors(d3.scale.ordinal().range(['#fc9272','#de2d26','#fee0d2']))
    .label(function(d){ // https://stackoverflow.com/questions/30465870
            return (d.value / ndx.groupAll().reduceCount().value() * 100).toFixed(0) + "%";
        });

  // System chart:
  var systemChart = dc.rowChart("#topSystemsChart");
  var systemDim = ndx.dimension(function (d) { return d["system"]; });
  var systemGroup = systemDim.group();

  systemChart
    .dimension(systemDim)
    .group(systemGroup)
    .elasticX(true)
    // http://colorbrewer2.org/#type=sequential&scheme=PuRd&n=9
    .colors(d3.scale.ordinal().range(['#ce1256','#e7298a','#df65b0','#c994c7','#d4b9da','#e7e1ef','#f7f4f9']))
    .data(function (group) { return group.top(5); });

  // Risk chart:
  var riskChart = dc.pieChart("#riskChart");
  var riskDim = ndx.dimension(function (d) { return d["risk"]; })
  var riskGroup = riskDim.group();

  riskChart
    .dimension(riskDim)
    .group(riskGroup)
    .legend(dc.legend())
    // http://colorbrewer2.org/#type=sequential&scheme=Reds&n=3
    .colors(d3.scale.ordinal().range(['#fc9272','#de2d26','#fee0d2']))
    .label(function(d){ // https://stackoverflow.com/questions/30465870
            return (d.value / ndx.groupAll().reduceCount().value() * 100).toFixed(0) + "%";
        });

  // category chart:
  // https://dc-js.github.io/dc.js/docs/html/dc.dataTable.html
  var categoryChart = dc.dataTable("#topCategoriesChart");
  var categoryDim = ndx.dimension(function (d) { return d["category"]; });
  var categoryGroup = categoryDim.group();

  var countOfCategories = categoryDim.group()
            .reduceCount(function(d) { return d["category"]; });
//  console.log(countOfCategories.top(Infinity));

  categoryChart
    .dimension(countOfCategories)
    .group(function (d) { return '' })
    .columns([
      { label: "Top Categories", format:function (d) { return d.key; } },
      { label: "#", format:function (d) { return d.value; } },
       ])
    .sortBy(function (d) { return d.value; })
    .order(d3.descending) //https://github.com/dc-js/dc.js/issues/1115
    .size(5);

  // Owners chart:
  //var ownersChart = dc.bubbleChart("#ownersAndVulnerabilitiesChart");
  //var ownersDim = ndx.dimension(function(d) { return d["owner"]; });
  // http://bl.ocks.org/jun9/5631952


  // Time Overall chart:
  var overallVolumeChart = dc.lineChart("#timelineChart");

  // Set the range of time x-axis:
  var timeParser = d3.time.format("%Y-%m-%d");
  var min = timeParser.parse("9999-99-99") ;
  var max = timeParser.parse("0000-00-00");
  for (var i in data) {
    var tmp = timeParser.parse(data[i]["identification_date"]);
    if (tmp <= min) {
      min = tmp;
    }
    if (tmp >= max) {
      max = tmp;
    }
  }
  
  var overallDim = ndx.dimension(function(d) { return timeParser.parse(d["identification_date"]); });
  var overallGroup = overallDim.group().reduceCount(function(d) { return d.identification_date; });

  overallVolumeChart 
    .x(d3.time.scale().domain([min, max]))
    .dimension(overallDim)
    .group(overallGroup)
    .legend(dc.legend().x(80).y(20).itemHeight(13).gap(5))
    .elasticX(true);

  // Rendering all charts:
  d3.selectAll("svg")
    .attr("width", "90%")
    .attr("viewbox","0 0 20 20");

  dc.renderAll();
});

