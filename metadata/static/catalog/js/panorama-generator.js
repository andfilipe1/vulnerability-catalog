/*
 * Panorama constructor using d3.js, dc.js an crossfilter.js
 */
url = "/catalog/vulnerability/data/json/dumpdatabase"

var perimeterChart = dc.rowChart("#perimeterChart"),
    riskChart = dc.pieChart("#riskChart"),
    systemChart = dc.rowChart("#topSystems"),
    categoryChart = dc.rowChart("#topCategories"),
    timelineChart = dc.barChart("#timelineChart");

d3.json(url, function(error, data) {
  if (error) throw error; 
 
  var ndx = crossfilter(data);
//  var all = ndx.groupAll();

  var perimeterDim = ndx.dimension(function (d) { return d["fields"]["perimeter"]; })
  var perimeterGroup = perimeterDim.group();

  var riskDim = ndx.dimension(function (d) { return d["fields"]["risk"]; })
  var riskGroup = riskDim.group();

  var systemDim = ndx.dimension(function (d) { return d["fields"]["system"]; })
  var systemGroup = systemDim.group();

  var categoryDim = ndx.dimension(function (d) { return d["fields"]["category"]; })
  var categoryGroup = categoryDim.group();

  perimeterChart
    .x(d3.scale.linear(perimeterDim))
    .dimension(perimeterDim)
    .group(perimeterGroup)
    .elasticX(true);

  riskChart
    .dimension(riskDim)
    .group(riskGroup)
    .legend(dc.legend());
 
  systemChart
    .dimension(systemDim)
    .group(systemGroup)
    .elasticX(true)
    .data(function (group) { return group.top(10); });

  categoryChart
    .dimension(categoryDim)
    .group(categoryGroup)
    .elasticX(true)
    .data(function (group) { return group.top(10); });

  dc.renderAll();
});

