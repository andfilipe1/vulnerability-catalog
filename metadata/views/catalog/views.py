from django.shortcuts import render

# Create your views here.
from django.shortcuts import get_object_or_404, render
from django.urls import reverse
from django.views import generic
from django.views.generic.edit import FormView

from django.core import serializers

from django.http import HttpResponseRedirect
from django.http import HttpResponse
from django.http import JsonResponse
from django.http import HttpResponseForbidden


from .models import Vulnerability


class IndexView(generic.ListView):
    template_name = 'catalog/index.html'
    context_object_name = 'vulnerability_list'

    def get_queryset(self):
        return Vulnerability.objects.order_by('-identification_date')

class AddView(FormView):
    template_name = 'catalog/add.html'
    form_class = AddVulnerabilityForm
    success_url = '/catalog/'

#    def form_valid(self, form):

class DetailView(generic.DetailView):
    model = Vulnerability
    template_name = 'catalog/detail.html'

class PanoramaView(generic.ListView):
    model = Vulnerability
    template_name = 'panorama/index.html'

class DataView(generic.ListView):
    model = Vulnerability
    template_name = 'data/index.html'

    def get_all_data(request):
### catalog/data/json/alldatabase:
        if request.user.is_authenticated:
            qs = list(Vulnerability.objects.all())
            qs = serializers.serialize('json', qs, \
                                              fields=('system', \
                                              'owner', \
                                              'environment', \
                                              'perimeter', \
                                              'technology', \
                                              'system_type', \
                                              'category', \
                                              'identification_date', \
                                              'risk', \
                                              'remediation_deadline', \
                                              'status'))
            return HttpResponse(qs, content_type='application/json')
        else:
            result = "Not allowed. You are not authenticated."
            return HttpResponseForbidden(result)


class RawDataView(generic.ListView):
### catalog/rawdata/?system=1&risk=2 to get a json with the parametes & values
    model = Vulnerability

    def rawdata(request):
        if request.user.is_authenticated:
            allowed_parameters = ['system', \
                                  'owner', \
                                  'environment', \
                                  'perimeter', \
                                  'technology', \
                                  'system_type', \
                                  'category', \
                                  'identification_date', \
                                  'risk', \
                                  'remediation_deadline', \
                                  'status']
    
    
            parameters = list(request.GET)
    
            result = dict()
    
            for p in parameters:
                if p in allowed_parameters:
                    result[p] = request.GET[p]
    
    
            return JsonResponse(result)
        else:
            result = "Not allowed. You are not authenticated."
            return HttpResponseForbidden(result)


