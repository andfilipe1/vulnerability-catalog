import platform
import os
import subprocess
import sys

from pathlib import Path


global PROJECT_NAME
global PROJECT_DIR

PROJECT_NAME="base"
PROJECT_DIR = Path(os.path.join(os.getcwd(), PROJECT_NAME,))

def get_environment():
    '''Returns a dictionary with relevant information about OS environment'''
    env = dict()
    env['system'] = platform.system()

    if env['system'] == 'Linux':
        env['system version'] = platform.linux_distribution()   
    if env['system'] == 'Windows':
        env['system version'] = platform.linux_distribution()

    return(env)

def run():
    env = get_environment()
    target = Path(os.path.join(os.getcwd(), 'venv',))

    # base/ dir was not found...
    if not Path(PROJECT_DIR).is_dir():
        print("Missing project's files. Maybe you miss to run\n") 
        print('python setup.py build')
        print('\nExiting.')
        sys.exit(1)

    # venv/ dir was not found...
    if not target.is_dir():
        print("Missing venv structure. Creating...")
        os.mkdir(target)
        if env['system'] == 'Linux':
            subprocess.call('python -m venv venv')
        print("venv created.")
        print("Please, run this script again.")
        sys.exit(1)
    else:
        if 'venv' in sys.prefix: # venv is loaded:
            os.chdir(PROJECT_DIR)
            subprocess.call('python manage.py runserver')
        else:
            print("\n[Warning]    Virtual Environment not load yet. Please, load venv by running:\n")
            if env['system'] == 'Linux':
                print('    source venv/bin/activate\n')
            if env['system'] == 'Windows':
                print('    venv\\Scripts\\activate.bat\n')
            print("and run this script again.")        
            sys.exit(1)


run()
